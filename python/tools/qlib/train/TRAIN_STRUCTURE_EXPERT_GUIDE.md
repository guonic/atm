# Structure Expert 模型训练完全指南

## 📚 目录

1. [什么是模型训练？](#什么是模型训练)
2. [这个脚本是做什么的？](#这个脚本是做什么的)
3. [快速开始](#快速开始)
4. [参数详解](#参数详解)
5. [训练流程详解](#训练流程详解)
6. [常见问题](#常见问题)

---

## 什么是模型训练？

### 简单理解

想象一下教一个小孩识别猫和狗：

1. **准备数据**：给小孩看很多猫和狗的照片，告诉他"这是猫"、"这是狗"
2. **学习过程**：小孩通过看照片，慢慢学会区分猫和狗的特征
3. **测试**：给小孩看新的照片，看他能不能正确识别

**模型训练**就是类似的过程：
- **数据**：股票的历史数据（价格、成交量等）
- **学习**：模型通过分析历史数据，学习股票涨跌的规律
- **预测**：训练完成后，模型可以预测未来股票的涨跌

### 为什么需要训练？

模型刚开始是"空白"的，就像刚出生的婴儿，什么都不懂。通过训练：
- 模型学会了从股票数据中提取有用信息
- 学会了识别哪些股票可能涨、哪些可能跌
- 学会了考虑行业关系（同行业的股票会相互影响）

---

## 这个脚本是做什么的？

### 功能概述

`train_structure_expert.py` 这个脚本的作用是：

**训练一个能够预测股票涨跌的智能模型**

### 模型的特点

这个模型叫做 **Structure Expert（结构专家）**，它的特殊之处在于：

1. **使用图神经网络（GNN）**：
   - 把股票之间的关系画成一张"图"
   - 同行业的股票会连接在一起
   - 模型可以学习"同行业股票会相互影响"这个规律

2. **考虑行业结构**：
   - 不是单独看每只股票
   - 会考虑同行业其他股票的表现
   - 比如：如果同行业的其他股票都在涨，这只股票也可能涨

3. **使用 Alpha158 特征**：
   - 每只股票用 158 个特征来描述（价格、成交量、技术指标等）
   - 这些特征包含了股票的各种信息

### 训练过程

训练脚本会：
1. 从数据库加载股票行业关系
2. 从 Qlib 加载股票的历史数据
3. 按日期一天一天地训练模型
4. 让模型学习"看到这些数据，股票会涨还是跌"
5. 保存训练好的模型

---

## 快速开始

### 最简单的使用方式

```bash
python python/tools/qlib/train/train_structure_expert.py \
    --start-date 2024-01-01 \
    --end-date 2024-12-31
```

**解释**：
- `--start-date`：从哪天开始训练（2024年1月1日）
- `--end-date`：训练到哪天（2024年12月31日）

### 保存训练好的模型

```bash
python python/tools/qlib/train/train_structure_expert.py \
    --start-date 2024-01-01 \
    --end-date 2024-12-31 \
    --save-model models/structure_expert.pth
```

**解释**：
- `--save-model`：训练完成后，把模型保存到这个文件
- 以后可以直接用这个文件，不需要重新训练

---

## 参数详解

### 必须参数（必须提供）

#### `--start-date`（开始日期）

**含义**：训练数据的开始日期

**格式**：`YYYY-MM-DD`（年-月-日）

**示例**：
```bash
--start-date 2024-01-01
```

**注意事项**：
- 必须是交易日（不是周末或节假日）
- 必须在 Qlib 数据的时间范围内
- 如果日期太早，脚本会自动调整到数据最早日期

**实际例子**：
- ✅ `2024-01-01` - 正确
- ❌ `2024-01-06` - 可能是周末，不是交易日
- ❌ `2020-01-01` - 如果数据从 2023 年开始，会自动调整

---

#### `--end-date`（结束日期）

**含义**：训练数据的结束日期

**格式**：`YYYY-MM-DD`（年-月-日）

**示例**：
```bash
--end-date 2024-12-31
```

**注意事项**：
- 必须晚于开始日期
- 必须是交易日
- 如果日期太晚，脚本会自动调整到数据最晚日期

**实际例子**：
- ✅ `2024-12-31` - 正确
- ❌ `2024-01-01` - 不能和开始日期一样
- ❌ `2025-12-31` - 如果数据只到 2024 年，会自动调整

---

### 可选参数（可以不提供，有默认值）

#### `--qlib-dir`（Qlib 数据目录）

**含义**：股票数据存储的位置

**默认值**：`~/.qlib/qlib_data/cn_data`

**示例**：
```bash
--qlib-dir ~/.qlib/qlib_data/cn_data
```

**解释**：
- `~` 表示你的用户主目录
- 完整路径可能是：`/Users/你的用户名/.qlib/qlib_data/cn_data`
- 如果数据在其他位置，需要指定完整路径

**什么时候需要改**：
- 数据存储在其他位置
- 有多个数据集，想用不同的数据训练

---

#### `--n-feat`（特征数量）

**含义**：每只股票用多少个特征来描述

**默认值**：`158`

**示例**：
```bash
--n-feat 158
```

**解释**：
- 158 是 Alpha158 特征集的数量
- 包括：价格、成交量、技术指标等
- **一般不需要改**，除非你用了不同的特征集

**什么时候需要改**：
- 使用了自定义的特征集（不是 Alpha158）
- 特征数量不是 158 个

---

#### `--n-hidden`（隐藏层大小）

**含义**：模型内部"思考"的维度大小

**默认值**：`64`

**示例**：
```bash
--n-hidden 128
```

**通俗解释**：
- 想象模型有一个"大脑"
- `n-hidden` 就是大脑的"容量"
- 数字越大，模型越"聪明"，但训练越慢

**建议值**：
- **64**：默认值，适合大多数情况
- **128**：更复杂的数据，需要更强的模型
- **256**：非常复杂的情况，但训练很慢

**什么时候需要改**：
- 模型预测效果不好，可以试试增大（如 128）
- 训练太慢，可以试试减小（如 32）

---

#### `--n-heads`（注意力头数）

**含义**：模型"注意力"的数量

**默认值**：`4`

**示例**：
```bash
--n-heads 8
```

**通俗解释**：
- 模型会"关注"不同方面的信息
- 就像人有多个"视角"看问题
- 头数越多，模型能同时关注更多方面

**建议值**：
- **4**：默认值，适合大多数情况
- **8**：更复杂的情况
- **16**：非常复杂，但训练很慢

**什么时候需要改**：
- 一般不需要改，除非有特殊需求

---

#### `--lr`（学习率）

**含义**：模型每次学习"迈的步子"有多大

**默认值**：`1e-3`（即 0.001）

**示例**：
```bash
--lr 0.001
```

**通俗解释**：
- **学习率太大**：模型"步子太大"，可能"走过头"，学不好
- **学习率太小**：模型"步子太小"，学得很慢
- **0.001**：是一个比较安全的默认值

**建议值**：
- **0.001**（1e-3）：默认值，适合大多数情况
- **0.0001**（1e-4）：如果训练不稳定，可以调小
- **0.01**（1e-2）：如果训练很慢，可以调大（但要小心）

**什么时候需要改**：
- 训练时出现 NaN（数值异常），调小学习率
- 训练很慢，可以稍微调大（但要小心）

---

#### `--device`（设备）

**含义**：用 CPU 还是 GPU 训练

**默认值**：`cuda`（GPU）

**示例**：
```bash
--device cuda    # 使用 GPU（如果有）
--device cpu     # 使用 CPU
```

**解释**：
- **GPU（cuda）**：训练速度快，但需要显卡
- **CPU**：训练速度慢，但任何电脑都能用

**什么时候需要改**：
- 没有 GPU，改成 `cpu`
- GPU 内存不够，改成 `cpu`

---

#### `--config`（配置文件）

**含义**：数据库配置文件的路径

**默认值**：`config/config.yaml`

**示例**：
```bash
--config config/config.yaml
```

**解释**：
- 配置文件包含数据库连接信息
- 脚本需要从数据库读取股票行业关系

**什么时候需要改**：
- 配置文件在其他位置
- 使用不同的配置文件

---

#### `--schema`（数据库模式）

**含义**：数据库中的"模式"名称

**默认值**：`quant`

**示例**：
```bash
--schema quant
```

**解释**：
- 数据库可以分成多个"模式"（类似文件夹）
- 股票数据存储在 `quant` 模式中

**什么时候需要改**：
- 数据存储在其他模式中

---

#### `--save-model`（保存模型）

**含义**：训练完成后，把模型保存到哪里

**默认值**：不保存（只训练，不保存）

**示例**：
```bash
--save-model models/structure_expert.pth
```

**解释**：
- 训练好的模型会保存到这个文件
- 以后可以直接用这个文件，不需要重新训练
- 文件扩展名通常是 `.pth`（PyTorch 模型文件）

**什么时候需要提供**：
- **总是建议提供**，这样训练好的模型可以重复使用

---

## 训练流程详解

### 整体流程

```
1. 检查参数
   ↓
2. 加载数据库配置
   ↓
3. 初始化 Qlib（加载股票数据）
   ↓
4. 检查日期范围（确保数据存在）
   ↓
5. 加载行业关系（哪些股票属于哪个行业）
   ↓
6. 初始化模型
   ↓
7. 开始训练（按日期循环）
   ↓
8. 保存模型（如果指定了 --save-model）
```

### 详细步骤

#### 步骤 1：检查参数

脚本会检查：
- 开始日期是否早于结束日期
- 日期格式是否正确

**如果出错**：
```
Start date must be before end date
```
**解决方法**：检查日期是否正确

---

#### 步骤 2：加载数据库配置

从配置文件读取数据库连接信息：
- 数据库地址
- 用户名、密码
- 数据库名称

**如果出错**：
```
Failed to load config: ...
```
**解决方法**：检查配置文件是否存在，格式是否正确

---

#### 步骤 3：初始化 Qlib

加载股票数据：
- 检查数据目录是否存在
- 加载交易日历
- 检查数据是否完整

**如果出错**：
```
No trading days found in Qlib data
```
**解决方法**：
1. 检查 `--qlib-dir` 路径是否正确
2. 确保已经导出了 Qlib 数据（运行 `export_qlib.py`）

---

#### 步骤 4：检查日期范围

脚本会：
- 检查数据的时间范围
- 如果指定的日期超出范围，自动调整

**示例输出**：
```
Available calendar range: 2023-01-01 to 2024-12-31
Start date 2024-01-01 is before available data, adjusting to 2023-01-01
```

**含义**：数据从 2023-01-01 开始，脚本自动调整了开始日期

---

#### 步骤 5：加载行业关系

从数据库读取：
- 每只股票属于哪个行业
- 同行业的股票会连接在一起

**如果出错**：
```
No industry mapping found. Please sync industry data first.
```
**解决方法**：
1. 运行行业数据同步脚本
2. 检查数据库是否有行业数据

---

#### 步骤 6：初始化模型

创建模型实例：
- 根据参数创建模型结构
- 初始化模型权重（随机值）

**输出示例**：
```
Initializing model and components...
Model initialized (n_feat=158, n_hidden=64, n_heads=4)
```

---

#### 步骤 7：开始训练（核心步骤）

这是最重要的步骤，脚本会：

**7.1 按日期循环**

对每个交易日：
1. 加载当天的股票数据（158 个特征）
2. 加载第二天的股票价格（作为"答案"）
3. 计算收益率（涨跌幅度）
4. 构建图结构（连接同行业的股票）
5. 训练模型（让模型学习预测）

**7.2 训练过程**

```
对于每一天：
  1. 加载数据
     ↓
  2. 构建图（连接同行业股票）
     ↓
  3. 模型预测（根据数据预测涨跌）
     ↓
  4. 计算误差（预测值和真实值的差距）
     ↓
  5. 调整模型（让误差变小）
```

**输出示例**：
```
Processed 10/144 days | Avg Loss: 0.001234 | Last Loss: 0.001156
Processed 20/144 days | Avg Loss: 0.001189 | Last Loss: 0.001098
...
```

**解释**：
- `Processed 10/144`：已经训练了 10 天，总共 144 天
- `Avg Loss`：平均误差（越小越好）
- `Last Loss`：最后一次训练的误差

---

#### 步骤 8：保存模型

如果指定了 `--save-model`：
- 把训练好的模型权重保存到文件
- 以后可以直接加载使用

**输出示例**：
```
Model saved to models/structure_expert.pth
```

---

## 完整示例

### 示例 1：基本训练

```bash
python python/tools/qlib/train/train_structure_expert.py \
    --start-date 2024-01-01 \
    --end-date 2024-06-30 \
    --save-model models/structure_expert_2024H1.pth
```

**解释**：
- 训练 2024 年上半年的数据
- 保存模型到指定文件

---

### 示例 2：使用 GPU 训练，调整参数

```bash
python python/tools/qlib/train/train_structure_expert.py \
    --start-date 2024-01-01 \
    --end-date 2024-12-31 \
    --n-hidden 128 \
    --n-heads 8 \
    --lr 0.0005 \
    --device cuda \
    --save-model models/structure_expert_large.pth
```

**解释**：
- 使用更大的模型（n-hidden=128）
- 使用更多注意力头（n-heads=8）
- 使用较小的学习率（更稳定）
- 使用 GPU 加速
- 保存模型

---

### 示例 3：使用 CPU 训练（没有 GPU）

```bash
python python/tools/qlib/train/train_structure_expert.py \
    --start-date 2024-01-01 \
    --end-date 2024-03-31 \
    --device cpu \
    --save-model models/structure_expert_cpu.pth
```

**解释**：
- 使用 CPU 训练（速度较慢）
- 只训练一个季度（减少训练时间）

---

## 常见问题

### Q1: 训练需要多长时间？

**答案**：取决于：
- **数据量**：日期范围越大，训练时间越长
- **设备**：GPU 比 CPU 快很多（可能快 10-100 倍）
- **模型大小**：n-hidden 越大，训练越慢

**估算**：
- CPU：一天数据可能需要 1-5 分钟
- GPU：一天数据可能需要 0.1-0.5 分钟

**示例**：
- 144 天数据，CPU：约 2-12 小时
- 144 天数据，GPU：约 15-75 分钟

---

### Q2: 训练时出现 "No data for ..." 警告

**原因**：某一天没有数据

**解决方法**：
- 这是正常的，脚本会自动跳过
- 如果太多天没有数据，检查数据是否完整

---

### Q3: 训练时出现 "No edges for ..." 警告

**原因**：某一天没有行业关系数据

**解决方法**：
- 检查行业数据是否已同步
- 确保数据库中有行业关系数据

---

### Q4: 训练时 Loss 一直是 NaN

**原因**：数值不稳定，可能是：
- 学习率太大
- 数据有问题
- 模型参数不合适

**解决方法**：
1. 降低学习率（如 `--lr 0.0001`）
2. 检查数据是否有异常值
3. 使用更小的模型（如 `--n-hidden 32`）

---

### Q5: 训练很慢怎么办？

**解决方法**：
1. 使用 GPU（`--device cuda`）
2. 减少训练天数（缩短日期范围）
3. 使用更小的模型（`--n-hidden 32`）
4. 使用更少的数据（只训练部分日期）

---

### Q6: 训练完成后如何使用模型？

**答案**：
1. 模型已保存到 `--save-model` 指定的文件
2. 可以使用 `check_structure_expert.py` 检查模型
3. 可以在其他脚本中加载模型进行预测

**示例**：
```python
import torch
from structure_expert import StructureExpertGNN

# 加载模型
model = StructureExpertGNN(n_feat=158, n_hidden=64, n_heads=4)
model.load_state_dict(torch.load("models/structure_expert.pth"))

# 使用模型进行预测
# ... (需要准备数据和图结构)
```

---

### Q7: 如何知道训练是否成功？

**检查点**：
1. ✅ 没有错误信息
2. ✅ Loss 值在合理范围内（通常 < 1.0）
3. ✅ Loss 逐渐下降（说明模型在学习）
4. ✅ 模型文件成功保存

**验证模型**：
```bash
python python/tools/qlib/train/check_structure_expert.py \
    --model_path models/structure_expert.pth
```

---

## 训练技巧

### 技巧 1：从小范围开始

**建议**：先用小范围数据测试：
```bash
# 先训练一个月
--start-date 2024-01-01 --end-date 2024-01-31
```

如果成功，再扩大范围。

---

### 技巧 2：监控 Loss

**观察**：
- Loss 应该逐渐下降
- 如果 Loss 一直很大或出现 NaN，调整参数

---

### 技巧 3：保存中间结果

**建议**：训练长时间时，可以：
- 定期检查模型文件
- 如果训练中断，可以从保存的模型继续

---

### 技巧 4：使用合适的参数

**推荐配置**：
- **初学者**：使用所有默认值
- **有经验**：根据数据调整 n-hidden 和 lr

---

## 总结

### 最简单的使用方式

```bash
python python/tools/qlib/train/train_structure_expert.py \
    --start-date 2024-01-01 \
    --end-date 2024-12-31 \
    --save-model models/structure_expert.pth
```

### 关键参数

1. **必须提供**：`--start-date`、`--end-date`
2. **强烈建议**：`--save-model`（保存模型）
3. **可选调整**：`--n-hidden`、`--lr`、`--device`

### 训练流程

1. 准备数据（Qlib 数据、行业数据）
2. 运行训练脚本
3. 等待训练完成
4. 检查模型文件
5. 使用模型进行预测

---

## 下一步

训练完成后，你可以：
1. 使用 `check_structure_expert.py` 检查模型
2. 使用模型进行股票预测
3. 可视化模型结果（使用 `visualize_structure_expert.py`）

---

**祝你训练顺利！** 🚀

