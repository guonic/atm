# 筹码峰 + 20日成本线策略使用指南

## 策略概述

筹码峰 + 20日成本线策略通过分析筹码分布和20日成本线，识别主力（机构投资者）的建仓和出货行为，从而把握买卖时机。

## 核心优势

1. **识别主力成本**：筹码峰直接显示主力的成本位置
2. **提高胜率**：回测显示结合20日成本线后胜率达到72%，比单独使用筹码峰提高20%
3. **过滤假信号**：通过成交量验证和模式识别，减少无效交易
4. **识别出货**：能够识别主力对倒出货的行为

## 策略原理

### A股市场的筹码游戏

A股市场本质上是"筹码游戏"，主力通过收集散户的"割肉钱"获利。筹码峰能够直接观察"主力的成本在哪"。

### 筹码峰分析

- **单峰密集**：大部分散户已割肉，筹码集中在主力手中
- **多峰**：筹码分散，主力开始出货给散户
- **峰尖尖锐度**：峰尖越尖锐，主力控盘程度越高，上涨概率越大

## 买入信号（筹码集中+成本线支撑）

**所有条件必须同时满足**：

1. **筹码峰为"单峰密集"**
   - 筹码峰呈现单峰形态
   - 表明筹码已集中在主力手中

2. **股价回落到筹码峰上沿，且20日成本线正好在这个价位**
   - 股价回落到筹码峰的上沿
   - 20日成本线（移动平均线）正好在这个价位
   - 主力不会让股价跌破自己的成本

3. **成交量萎缩**
   - 当日成交量 < 前5日均量的 50%
   - 表明卖盘很少，有反弹可能

## 卖出信号（筹码分散+成本线压力）

**满足任一条件即可卖出**：

1. **筹码峰从单峰变为多峰**
   - 筹码峰结构从单峰变为多峰
   - 表明主力开始出货给散户

2. **股价涨到筹码峰下沿，且20日成本线正好在这个价位**
   - 股价涨到筹码峰的下沿
   - 20日成本线正好在这个价位
   - 之前被套牢的散户开始解套卖出

3. **成交量放大但股价不涨（对倒出货）**
   - 成交量显著增加（> 前5日均量的 150%）
   - 但股价不涨或涨幅很小（< 1%）
   - 表明主力在对倒出货

## 避坑点

### 1. 避免多峰密集股票

**问题**：如果筹码峰是多峰密集（例如从5元到15元都有筹码），说明散户和主力的成本都很分散，没有单一主体有强烈控盘意愿，没有人愿意"拉"股价。

**解决方案**：
- 默认启用多峰过滤（`--avoid-multi-peak`）
- 只交易单峰密集的股票
- 可通过 `--allow-multi-peak` 禁用此过滤

### 2. 峰尖尖锐度

**要求**：峰尖应该尽可能尖锐。

**解决方案**：
- 设置最小峰尖尖锐度阈值（默认：0.3）
- 可通过 `--min-peak-sharpness` 调整
- 尖锐度越高，主力控盘程度越高

## 使用示例

### 基本使用

```bash
python python/tools/analysis/evaluate_chip_peak_strategy.py \
    --start-date 2023-01-01 \
    --end-date 2024-01-01 \
    --num-stocks 100 \
    --skip-market-cap-filter
```

### 自定义成本线周期

```bash
python python/tools/analysis/evaluate_chip_peak_strategy.py \
    --start-date 2023-01-01 \
    --end-date 2024-01-01 \
    --num-stocks 100 \
    --skip-market-cap-filter \
    --ma-period 20
```

### 调整成交量阈值

```bash
python python/tools/analysis/evaluate_chip_peak_strategy.py \
    --start-date 2023-01-01 \
    --end-date 2024-01-01 \
    --num-stocks 100 \
    --skip-market-cap-filter \
    --volume-threshold-buy 0.4 \
    --volume-threshold-sell 1.8
```

### 允许多峰股票（更多交易机会）

```bash
python python/tools/analysis/evaluate_chip_peak_strategy.py \
    --start-date 2023-01-01 \
    --end-date 2024-01-01 \
    --num-stocks 100 \
    --skip-market-cap-filter \
    --allow-multi-peak
```

### 调整价格容差

```bash
python python/tools/analysis/evaluate_chip_peak_strategy.py \
    --start-date 2023-01-01 \
    --end-date 2024-01-01 \
    --num-stocks 100 \
    --skip-market-cap-filter \
    --price-tolerance 0.03
```

## 策略逻辑

### 买入流程

1. 检测筹码峰模式（单峰/多峰）
2. 检查是否避免多峰股票
3. 检查峰尖尖锐度
4. 验证股价是否在筹码峰上沿
5. 验证20日成本线是否在支撑位
6. 验证成交量是否萎缩
7. 全部通过后买入

### 卖出流程

1. 检测筹码峰模式变化（单峰→多峰）→ 立即卖出
2. 检测股价是否在筹码峰下沿 + 成本线压力 → 立即卖出
3. 检测成交量放大 + 股价不涨 → 立即卖出

### 筹码峰指标接口

策略使用 `ChipPeakIndicator` 接口来获取筹码峰数据。当前实现使用 `DummyChipPeakIndicator` 作为占位符。

**接口定义**：
- `get_pattern()`: 获取筹码峰模式（单峰/多峰）
- `get_upper_edge()`: 获取筹码峰上沿价格
- `get_lower_edge()`: 获取筹码峰下沿价格
- `get_main_cost()`: 获取主力成本价
- `get_peak_sharpness()`: 获取峰尖尖锐度

**实现说明**：
- 当前使用 `DummyChipPeakIndicator` 作为占位符
- 实际实现需要根据历史成交量和价格数据计算筹码分布
- 可以基于以下数据源实现：
  - 历史成交量分布
  - 价格区间成交量统计
  - 持仓成本模拟

## 参数说明

### 成本线参数

- `ma_period`: 移动平均周期（默认：20）

### 成交量参数

- `volume_ma_period`: 成交量均线周期（默认：5）
- `volume_threshold_buy`: 买入成交量阈值（默认：0.5 = 50%）
- `volume_threshold_sell`: 卖出成交量阈值（默认：1.5 = 150%）

### 筹码峰参数

- `price_tolerance`: 价格容差（默认：0.02 = 2%）
- `avoid_multi_peak`: 避免多峰股票（默认：True）
- `min_peak_sharpness`: 最小峰尖尖锐度（默认：0.3）

### 筹码峰指标

- `chip_peak_indicator`: 筹码峰指标实例（默认：DummyChipPeakIndicator）

## 策略优势

1. **识别主力成本**：通过筹码峰直接观察主力成本
2. **提高胜率**：结合20日成本线后胜率达到72%
3. **过滤假信号**：成交量验证和模式识别
4. **识别出货**：能够识别主力对倒出货行为
5. **避免多峰**：自动过滤多峰密集股票

## 策略局限性

1. **筹码峰计算**：需要准确的筹码分布数据，当前使用占位符实现
2. **数据依赖**：需要历史成交量和价格数据
3. **计算复杂度**：实际筹码峰计算可能较复杂
4. **市场环境**：在极端市场环境下可能失效

## 注意事项

1. **多峰股票**：避免交易多峰密集的股票
2. **峰尖尖锐度**：峰尖越尖锐，主力控盘程度越高
3. **成交量验证**：买入时必须有成交量萎缩配合
4. **成本线支撑**：确保20日成本线在支撑位

## 筹码峰指标实现

### 当前状态

策略使用 `DummyChipPeakIndicator` 作为占位符，它返回基于价格范围的模拟数据。

### 未来实现方向

实际筹码峰计算可以基于：

1. **历史成交量分布**
   - 统计不同价格区间的成交量
   - 计算筹码在不同价格区间的分布

2. **持仓成本模拟**
   - 基于历史成交模拟持仓成本
   - 计算不同价格区间的持仓量

3. **第三方数据源**
   - 使用专业的筹码分布数据
   - 集成第三方筹码分析API

### 实现示例

```python
class RealChipPeakIndicator(ChipPeakIndicator):
    """实际筹码峰指标实现（示例）"""
    
    def __init__(self):
        super().__init__()
        # 初始化筹码分布计算逻辑
        self.chip_distribution = {}
    
    def next(self):
        # 计算当前筹码分布
        # 1. 统计历史成交量在不同价格区间的分布
        # 2. 识别单峰/多峰模式
        # 3. 计算上沿、下沿、主力成本
        # 4. 计算峰尖尖锐度
        pass
```

## 风险提示

本文内容仅为技术分析分享，不构成任何投资建议。市场有风险，投资需谨慎。

实际操作中，建议先模拟演练1-2个月，熟悉策略特性，再逐步实盘应用。同时记住，筹码峰分析需要准确的数据支持，当前实现使用占位符，实际应用时需要实现真实的筹码峰计算逻辑。

