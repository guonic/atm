这份文档总结了股票结构特征深度挖掘中的五种核心相关性计算方法。这些方法旨在榨干基础 GNN 的潜力，通过构建**动态、有向、多中心**的图拓扑，量化个股间的联动、因果与信息流。

---

# 股票结构特征相关性计算技术文档

## 1. 动态截面相关性 (Dynamic Cross-Sectional Correlation)
**用途**：基础拓扑构建。识别哪些股票当前处于同一“情绪簇”。
*   **数学公式**：
    $$R_{i,j} = \frac{\sum_{t=1}^n (r_{i,t} - \bar{r}_i)(r_{j,t} - \bar{r}_j)}{\sqrt{\sum_{t=1}^n (r_{i,t} - \bar{r}_i)^2 \sum_{t=1}^n (r_{j,t} - \bar{r}_j)^2}}$$
*   **计算方法**：在 Go 后端取 $T-n$ 窗口内的收益率序列，计算 Pearson 系数。
*   **工程建议**：通过 KNN 算法或设定阈值 $\theta$（如 $R > 0.5$）对图进行稀疏化。

## 2. 滞后相关性 (Cross-Lagged Correlation)
**用途**：打破对称性，识别“领头羊”与“跟风者”，构建**有向图**。
*   **数学公式**：
    $$W_{A \to B} = \text{Corr}(A_{t-k}, B_t)$$
*   **计算方法**：将股票 A 的序列整体向过去平移 $k$ 个单位，计算平移后的 A 与原始 B 的相关性。
*   **判定逻辑**：若 $\text{Corr}(A_{t-1}, B_t) > \text{Corr}(B_{t-1}, A_t)$，则建立 $A \to B$ 的有向边，判定 A 为当前盘面发动机。

## 3. 协同波动率 (Volatility Sync)
**用途**：衡量风险状态一致性。识别受同一类资金（如量化高频阵列）控制的股票。
*   **计算逻辑（基于 Range）**：
    1. 计算每支股票的日内振幅：$Range_{i,t} = \ln(High_{i,t} / Low_{i,t})$。
    2. 计算同步率：$Sync_{i,j} = 1 - \frac{|Range_i - Range_j|}{Range_i + Range_j}$。
*   **边特征转化**：使用高斯核函数映射：$e_{ij} = \exp\left( - \frac{(\sigma_i - \sigma_j)^2}{2h^2} \right)$。
*   **判定深度**：值越接近 1，风险节奏越一致，即便涨跌方向有时不一致。

## 4. 格兰杰因果检验 (Granger Causality)
**用途**：统计学判定因果方向，过滤掉纯随机的“伪相关”。
*   **数学模型**：
    比较两个回归模型：
    1.  $B_t = \sum \alpha_i B_{t-i} + \epsilon_1$
    2.  $B_t = \sum \alpha_i B_{t-i} + \sum \beta_j A_{t-j} + \epsilon_2$
*   **计算指标**：计算 **F 检验** 的 $P\text{-value}$。
*   **计算方法**：若加入 A 的历史后模型预测能力显著提升（$P < 0.05$），则判定 A 引导 B。推荐在 Python (Statsmodels) 中计算。

## 5. 传递熵 (Transfer Entropy / TE)
**用途**：捕捉非线性信息流。衡量从 A 传递到 B 的“确定性”大小。
*   **数学公式**：
    $$TE_{A \to B} = \sum p(B_{t+1}, B_t, A_t) \log \frac{p(B_{t+1} | B_t, A_t)}{p(B_{t+1} | B_t)}$$
*   **计算逻辑**：
    1.  **符号化**：将收益率映射为符号（如：大跌=-1，震荡=0，大涨=1）。
    2.  **熵计算**：计算知道 A 的过去后，预测 B 的未来的熵减速度。
*   **判定逻辑**：$\Delta TE = TE_{A \to B} - TE_{B \to A}$ 为正说明 A 是信息源，为负说明 B 是信息源。

---

### 指标对比汇总表

| 指标 | 维度 | 有向性 | 捕捉能力 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **截面相关性** | 价格线性 | 无 | 静态板块联动 | 最基础，Go 计算 |
| **滞后相关性** | 价格线性 | **有** | 价格领先/滞后 | 识别领头羊 |
| **协同波动率** | 风险振幅 | 无 | 资金属性一致性 | 过滤虚假联动 |
| **格兰杰检验** | 时间序列 | **有** | 线性预测因果 | 统计显著性评估 |
| **传递熵** | 信息分布 | **有** | 非线性情绪传导 | 捕捉隐蔽的信息链 |

### 模型输入集成建议 (GNN Edge Features)
在第一阶段，将上述指标组合为一个多维向量赋给边特征 $e_{ij}$：
```python
# 边特征向量建议
Edge_Feature_ij = [
    correlation_value,     # 截面联动
    lagged_weight,         # 滞后权重
    volatility_sync_score, # 风险同步
    transfer_entropy       # 信息流向强度
]
```
通过 GAT (Graph Attention Network) 自动通过这些结构化指标学习节点间的复杂博弈关系，从而在引入神经网络新模型（如 ExitExpert）前最大化基础架构的预测效能。