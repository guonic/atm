#!/bin/bash

# atm - 主入口脚本，支持子命令插件机制
# 类似于 kubectl 的命令结构

set -e

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# 显示帮助信息
show_help() {
    cat << EOF
用法: atm <command> [options]

命令:
  storage   管理数据库服务（TimescaleDB）
            - start: 启动数据库服务
            - stop: 停止数据库服务
            - restart: 重启数据库服务
            - status: 查看服务状态
            - login: 登录数据库
            - psql: 打印 psql 连接命令

  sync      数据同步任务
            - stock-basic: 同步股票基础信息（覆盖模式）
            - trading-calendar: 同步交易日历数据（覆盖模式）
            - kline: 同步K线数据（追加模式）
            - premarket: 同步股票盘前数据（股本情况）

  help      显示此帮助信息

示例:
  atm storage start
  atm storage stop
  atm storage login
  atm storage psql
  atm sync stock-basic
  atm sync stock-basic --exchange SSE
  atm sync trading-calendar
  atm sync kline --type day
  atm sync premarket --trade-date 20241222
  atm help

EOF
}

# 执行子命令
execute_subcommand() {
    local command=$1
    shift
    
    case "$command" in
        storage)
            if [ -f "$SCRIPT_DIR/storage_controller.sh" ]; then
                "$SCRIPT_DIR/storage_controller.sh" "$@"
            else
                echo "错误: 找不到 storage_controller.sh 脚本"
                exit 1
            fi
            ;;
        sync)
            if [ -f "$SCRIPT_DIR/sync_controller.sh" ]; then
                "$SCRIPT_DIR/sync_controller.sh" "$@"
            else
                echo "错误: 找不到 sync_controller.sh 脚本"
                exit 1
            fi
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo "错误: 未知命令 '$command'"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# 主逻辑
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    execute_subcommand "$@"
}

main "$@"

